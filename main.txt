from fastapi import FastAPI,HTTPException
from pydantic import BaseModel,EmailStr
import psycopg2
from psycopg2.extras import RealDictCursor

app=FastAPI(title="Employee Management App")

DB_URL="postgresql://postgres:12345678@localhost:5432/My_DB"

def get_conn():
    return psycopg2.connect(DB_URL,cursor_factory=RealDictCursor)
	
#pydanticschemas

class Employee(BaseModel):
    name:str
	department:str
	email:EmailStr
	
class EmployeeOut(Employee):
    id:int
	
#crud routes

@app.get("/")
def intro():
    return {"message":"Welcome to Employee Management App"}
	
@app.post("/employee_create",response_model=EmployeeOut)
def create(emp:Employee):
    conn.get_conn()
	cur=conn.cursor()
	try:
	    cur.execute("INSERT INTO employees(name,department,email)Values(%s,%s,%s)RETURNING *",(emp.name,emp.department,emp.email))
		row=cur.fetchone()
		conn.commit()
		return row
	except Exception as e:
	    conn.rollback()
	    raise HTTPException(status_code=400,detail=str(e))
	finally:
	    cur.close()
		conn.close()
		
@app.get("/employees",response_model=List[EmployeeOut])
def get_all_employees():
    conn =get_conn()
	cur = conn.cursor()
	cur.execute("SELECT * FROM employees ")
	rows=cur.fetchall()
	cur.close()
	conn.close()
	return rows
	

		